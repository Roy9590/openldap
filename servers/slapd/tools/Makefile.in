# $OpenLDAP$
#-----------------------------------------------------------------------------
# Copyright (c) 1995 Regents of the University of Michigan.
# All rights reserved.
#
# Redistribution and use in source and binary forms are permitted
# provided that this notice is preserved and that due credit is given
# to the University of Michigan at Ann Arbor. The name of the University
# may not be used to endorse or promote products derived from this
# software without specific prior written permission. This software
# is provided ``as is'' without express or implied warranty.
#
#       Stand alone LDAP server tools makefile
#
#-----------------------------------------------------------------------------
BUILD_LDBM = @BUILD_LDBM@
BUILD_BDB2 = @BUILD_BDB2@
BUILD_QUIPU = @BUILD_QUIPU@

LDAP_INCDIR= ../../../include       
LDAP_LIBDIR= ../../../libraries

SLAP_DIR=../
SLAPD_MODULES = @SLAPD_MODULES_LIST@
XDEFS = $(MODULES_CPPFLAGS)
XLDFLAGS = $(MODULES_LDFLAGS) $(SLAPD_MODULES)

XLIBS = -lavl -lldif -lldbm -llutil -lldap_r -llber
XXLIBS = $(LDAPD_LIBS) $(SLAPD_LIBS) \
	$(PERL_LDFLAGS) $(LDBM_LIBS) $(SECURITY_LIBS) \
	$(LDIF_LIBS) $(LUTIL_LIBS)
XXXLIBS = $(LTHREAD_LIBS) $(MODULES_LIBS)

PROGRAMS=ldif slappasswd slapadd slapcat slapindex
LDBMPROGRAMS=centipede sizecount
BDB2PROGRAMS=
QUIPUPROGRAMS=chlog2replog edb2ldif

# CPPFLAGS will include the defines for dynamic libs in Mingw32.
NT_DYN_DEFS = -DLIBLBER_DECL=dllimport -DLIBLDAP_DECL=dllimport
CPPFLAGS = $(@PLAT@_@LIB_LINKAGE@_DEFS)

SRCS = ldif.c mimic.c slapcommon.c

XSRCS = edb2-vers.c

LDBMSRCS = centipede.c sizecount.c

BDB2SRCS =

QUIPUSRCS	= edb2ldif.c ldapsyntax.c chlog2replog.c
SLAPD_OBJS = ../config.o ../ch_malloc.o ../backend.o ../charray.o \
		../module.o ../aclparse.o ../filterentry.o \
		../schema.o ../schema_init.o ../schemaparse.o \
		../acl.o ../phonetic.o ../attr.o ../value.o ../entry.o \
		../dn.o ../filter.o ../str2filter.o ../ava.o ../init.o \
		../controls.o ../kerberos.o ../passwd.o \
		../extended.o ../starttls.o

SLAPOBJS = $(SLAPD_OBJS) slapcommon.o mimic.o

EDB2LDIFSRCS    = edb2ldif.c ldapsyntax.c
EDB2LDIFOBJS    = edb2ldif.o ldapsyntax.o

UNIX_PRGS = build-ldbm build-bdb2 build-quipu

all-local: build-progs $(@PLAT@_PRGS)

build-progs: $(PROGRAMS)

build-ldbm: ldbm-tools-$(BUILD_LDBM)
ldbm-tools-no:
	@echo "run configure with --enable-ldbm to build LDBM tools"

ldbm-tools-yes ldbm-tools-mod: $(LDBMPROGRAMS)

build-bdb2: bdb2-tools-$(BUILD_BDB2)
bdb2-tools-no:
	@echo "run configure with --enable-bdb2 to build BDB2 tools"

bdb2-tools-yes bdb2-tools-mod: $(BDB2PROGRAMS)

build-quipu: quipu-tools-$(BUILD_QUIPU)
quipu-tools-no:
	@echo "run configure with --enable-quipu to build QUIPU tools"

quipu-tools-yes quipu-tools-mod: $(QUIPUPROGRAMS)

#
# SLAP Tools
#
slapadd:	slapadd.o ../libbackends.a $(SLAPOBJS) $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ slapadd.o $(SLAPOBJS) ../libbackends.a $(LIBS)

slapcat:	slapcat.o ../libbackends.a $(SLAPOBJS) $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ slapcat.o $(SLAPOBJS) ../libbackends.a $(LIBS)

slapindex:	slapindex.o ../libbackends.a $(SLAPOBJS) $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ slapindex.o $(SLAPOBJS) ../libbackends.a $(LIBS)

ldif:		ldif.o $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ ldif.o $(LIBS)

slappasswd:		slappasswd.o $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ slappasswd.o $(LIBS)

#
# LDBM Specific Tools
#
centipede:	centipede.o $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ centipede.o $(LIBS)

sizecount:	sizecount.o ../phonetic.o ../ch_malloc.o $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ sizecount.o ../phonetic.o ../ch_malloc.o $(LIBS)

#
# BDBM Specific Tools
#

#
# QUIPU Specific Tools
#
edb2ldif:	edb2-vers.o
	$(CC) $(LDFLAGS) -o $@ $(EDB2LDIFOBJS) edb2-vers.o $(LIBS)

edb2-vers.c: $(EDB2LDIFOBJS)
	@-$(RM) $@
	$(MKVERSION) ebd2ldif > $@

chlog2replog: chlog2replog.o ../lock.o ../ch_malloc.o $(SLAPD_LIBDEPEND) 
	$(LTLINK) -o $@ chlog2replog.o ../lock.o ../ch_malloc.o $(LIBS)

clean-local: FORCE
	$(RM) $(PROGRAMS) $(LDBMPROGRAMS) $(BDB2PROGRAMS) $(QUIPUPROGRAMS) \
		$(XPROGRAMS) $(XSRCS) *.o core .libs/* *.exe

depend-local: FORCE
	DEPEND_LDBM= ; DEPEND_BDB2= ; DEPEND_QUIPU= ; \
	if [ "$(BUILD_LDBM)" != "no" ]; then \
		DEPEND_LDBM="$(LDBMSRCS)"; \
	fi; \
	if [ "$(BUILD_BDB2)" != "no" ]; then \
		DEPEND_BDB2="$(BDBMSRCS)"; \
	fi; \
	if [ "$(BUILD_QUIPU)" != "no" ]; then \
		DEPEND_QUIPU="$(QUIPUINCLUDEFLAG) $(QUIPUSRCS)"; \
	fi; \
	$(MKDEP) $(DEFS) $(DEFINES) $(SRCS) $$DEPEND_QUIPU \
			$$DEPEND_LDBM $$DEPEND_BDB2

install-local: install-ldbm-$(BUILD_LDBM) install-bdb2-$(BUILD_BDB2) \
	 install-quipu-$(BUILD_QUIPU)

install-ldbm-no install-bdb2-no install-quipu-no:

install-ldbm-yes install-ldbm-mod: FORCE
	-$(MKDIR) $(DESTDIR)$(sbindir) 
	@for bin in $(PROGRAMS); do \
		$(LTINSTALL) $(INSTALLFLAGS) -m 755 $$bin$(EXEEXT) \
					    	    $(DESTDIR)$(sbindir); \
	done

install-bdb2-yes install-bdb2-mod: FORCE
	@-$(MKDIR) $(DESTDIR)$(sbindir) 

install-quipu-yes: FORCE
	@-$(MKDIR) $(DESTDIR)$(sbindir)
	for bin in edb2ldif chlog2replog; do \
		$(LTINSTALL) $(INSTALLFLAGS) -m 755 $$bin $(DESTDIR)$(sbindir); \
	done
