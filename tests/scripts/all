#! /bin/sh
# $OpenLDAP$

# disable LDAP initialization
LDAPNOINIT=true; export LDAPNOINIT

echo ">>>>> Executing all LDAP tests..."

if test $# -eq 0 ; then
	SRCDIR="."
else
	SRCDIR=$1; shift
fi

echo ">>>>> Test Directory: $SRCDIR"

if test $# -eq 0 ; then
	BACKEND=bdb
else
	BACKEND=$1; shift
fi

echo ">>>>> Backend: $BACKEND"

MONITORDB=${MONITORDB-no}
PROXYCACHE=${PROXYCACHE-no}
WITHTLS=${WITHTLS-no}
BACKENDTYPE=${BACKENDTYPE-yes}

export MONITORDB PROXYCACHE WITHTLS BACKENDTYPE

echo ">>>>> Backend Type: $BACKENDTYPE"

if test $# -eq 0 ; then
	SYNCREPL=no
else
	SYNCREPL=$1; shift
fi

SHTOOL="$SRCDIR/../build/shtool"

TB=`$SHTOOL echo -e "%B"`
TN=`$SHTOOL echo -e "%b"`

for CMD in $SRCDIR/scripts/test*; do
	echo ">>>>> Starting ${TB}`basename $CMD`${TN} ..."
	$CMD $SRCDIR $BACKEND $SYNCREPL
	RC=$?
	if test $RC -eq 0 ; then
		echo ">>>>> $CMD completed ${TB}OK${TN}."
	else
		echo ">>>>> $CMD ${TB}failed${TN} (exit $RC)"
		exit $RC
	fi
	echo ">>>>> waiting 10 seconds for things to exit"
	sleep 10
	echo ""
done
