# $OpenLDAP$
## Copyright 1998-2003 The OpenLDAP Foundation, All Rights Reserved.
## COPYING RESTRICTIONS APPLY, see COPYRIGHT file
##
## tests Makefile.in for OpenLDAP
SUBDIRS= progs
BUILD_BDB=@BUILD_BDB@
BUILD_HDB=@BUILD_HDB@
BUILD_LDBM=@BUILD_LDBM@
BUILD_MONITOR=@BUILD_MONITOR@
BUILD_CACHE=@BUILD_CACHE@

test:	tests
tests:	ldbm
ldbm:	hdb
hdb:	bdb

links:	data schema ucdata
data:
	@-$(LN_S) $(srcdir)/data .
schema:
	@-$(LN_S) $(top_srcdir)/servers/slapd/schema .
ucdata:
	@-$(LN_S) ../libraries/liblunicode ucdata

dirs:	test-db test-repl
test-db test-repl:
	@$(MKDIR) $@

test-bdb:	bdb
bdb:	bdb-$(BUILD_BDB)
bdb-no:
	@echo "run configure with --enable-bdb"

bdb-yes bdb-mod:	links dirs FORCE
	@echo "Initiating LDAP tests for BDB..."
	@MONITORDB=$(BUILD_MONITOR) PROXYCACHE=$(BUILD_CACHE) BACKENDTYPE=$(BUILD_BDB) $(srcdir)/scripts/all $(srcdir) bdb bdb

test-hdb:	hdb
hdb:	hdb-$(BUILD_HDB)
hdb-no:
	@echo "run configure with --enable-hdb"

hdb-yes hdb-mod:	links dirs FORCE
	@echo "Initiating LDAP tests for HDB..."
	@MONITORDB=$(BUILD_MONITOR) PROXYCACHE=$(BUILD_CACHE) BACKENDTYPE=$(BUILD_HDB) $(srcdir)/scripts/all $(srcdir) hdb hdb

test-ldbm:	ldbm
ldbm:	ldbm-$(BUILD_LDBM)
ldbm-no:
	@echo "run configure with --enable-ldbm"

ldbm-yes ldbm-mod:	links dirs FORCE
	@echo "Initiating LDAP tests for LDBM..."
	@MONITORDB=$(BUILD_MONITOR); PROXYCACHE=$(BUILD_CACHE); \
	BACKENDTYPE=$(BUILD_LDBM); export MONITORDB PROXYCACHE BACKENDTYPE; \
	if test "$(BUILD_BDB)" != "no"; then \
			$(srcdir)/scripts/all $(srcdir) ldbm bdb ; \
	else \
		if test "$(BUILD_HDB)" != "no"; then \
				$(srcdir)/scripts/all $(srcdir) ldbm hdb ; \
		else \
				$(srcdir)/scripts/all $(srcdir) ldbm no ; \
		fi ; \
	fi

passwd: test-passwd
test-passwd:	links dirs FORCE
	@echo "Initiating LDAP tests..."
	@$(srcdir)/scripts/passwd-search $(srcdir) passwd

test-nis-schema:        test-nis-schema-ldbm
test-nis-schema-ldbm:	links dirs FORCE
	@echo "Initiating LDAP server with NIS schema & ldbm backend..."; \
	$(srcdir)/scripts/startup_nis_ldap_server.sh $(srcdir) ldbm

clean-local:	FORCE
	-$(RM) -r test-db/[!C]* test-repl/[!C]* test-cache/[!C]* *leak *gmon *core

veryclean-local: FORCE
	@-$(RM) data schema ucdata
	-$(RM) -r test-db test-repl test-cache

